<mat-card>
  <mat-card-title>Pedido</mat-card-title>
  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="salvar()">
      <mat-form-field appearance="fill" class="full-width" subscriptSizing="dynamic">
        <mat-label>Cliente</mat-label>
        <mat-select formControlName="clienteId" required panelClass="dropdown-below">
          <mat-option>
            <input matInput placeholder="Buscar..." (click)="$event.stopPropagation()" (keyup)="$event.stopPropagation()"
                   #filtroCliente>
          </mat-option>
          <mat-option *ngFor="let c of clientes | filterBy:filtroCliente.value : 'nome'" [value]="c.id">{{c.nome}}</mat-option>
        </mat-select>
        <mat-error *ngIf="form.controls.clienteId.hasError('required')">Informe o cliente</mat-error>
      </mat-form-field>

      <div style="margin-bottom:8px"><strong>Total:</strong> {{ total | currency:'BRL' }}</div>

      <mat-form-field appearance="fill">
        <mat-label>Status</mat-label>
        <mat-select formControlName="status" required>
          <mat-option value="LANCADO">Lançado</mat-option>
          <mat-option value="EM_ANDAMENTO">Em andamento</mat-option>
          <mat-option value="DESPACHADO">Despachado</mat-option>
        </mat-select>
      </mat-form-field>

      <h3>Itens</h3>
      <div formArrayName="itens">
        <div *ngFor="let it of itens.controls; let i = index" [formGroupName]="i" class="item-row">
          <mat-form-field appearance="fill" subscriptSizing="dynamic">
            <mat-label>Produto</mat-label>
            <mat-select formControlName="produtoId" (selectionChange)="onProdutoSelected(i, $event.value)" panelClass="dropdown-below">
              <mat-option>
                <input matInput placeholder="Buscar..." (click)="$event.stopPropagation()" (keyup)="$event.stopPropagation()" #filtroProduto>
              </mat-option>
              <mat-option *ngFor="let p of produtos | filterBy:filtroProduto.value : 'nome'" [value]="p.id">{{p.nome}} - {{p.preco | currency:'BRL'}}</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Quantidade</mat-label>
            <input matInput type="number" formControlName="quantidade" required>
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Valor Unitário</mat-label>
            <input matInput type="number" step="0.01" formControlName="valorUnitario" required>
          </mat-form-field>

          

          <mat-form-field appearance="fill" class="full-width">
            <mat-label>Número de Série</mat-label>
            <input matInput formControlName="numeroSerie">
          </mat-form-field>

          <button mat-button color="warn" type="button" (click)="removeItem(i)">Remover</button>
        </div>
      </div>

      <button mat-stroked-button type="button" (click)="addItem()">Adicionar Item</button>

      <button mat-raised-button color="primary" type="submit" [disabled]="saving">Salvar</button>
      <button mat-button type="button" routerLink="/pedidos">Cancelar</button>
    </form>
  </mat-card-content>
</mat-card>



